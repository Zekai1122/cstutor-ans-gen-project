<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prompt Q&A</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div id="chat-container" class="centered">
    <div id="chat-history" class="chat-history"></div>

    <div class="input-area">
      <textarea id="question" placeholder="Ask anything..." rows="1"></textarea>
      <button id="submit">âž¤</button>
    </div>
  </div>

  <script>
    const API_URL = "https://cstutor-ans-gen-project-api.onrender.com/ask";
    const chatHistoryEl = document.getElementById("chat-history");
    const input = document.getElementById("question");
    const button = document.getElementById("submit");
    const container = document.getElementById("chat-container");

    const messages = [
      { role: "system", content: "Always start your answer with: 'Hello student.'" }
    ];

    let isSending = false;

    function appendMessage(role, content) {
      const wrapper = document.createElement("div");
      wrapper.className = `bubble ${role}`;
      wrapper.innerHTML = marked.parseInline(content.replace(/\n+$/, ''));
      chatHistoryEl.appendChild(wrapper);
      chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
    }

    function switchToChatMode() {
      container.classList.remove("centered");
      chatHistoryEl.classList.add("active");
    }

    async function sendQuestion() {
      const question = input.value.trim();
      if (!question || isSending) return;

      isSending = true;
      button.disabled = true;

      if (!chatHistoryEl.classList.contains("active")) switchToChatMode();

      appendMessage("user", question);
      input.value = "";
      messages.push({ role: "user", content: question });

      appendMessage("assistant", "Thinking...");

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages })
        });

        const data = await res.json();
        chatHistoryEl.lastChild.remove();
        const reply = data.reply || "Sorry, something went wrong.";
        messages.push({ role: "assistant", content: reply });
        appendMessage("assistant", reply);
      } catch (err) {
        chatHistoryEl.lastChild.remove();
        appendMessage("assistant", "Error: " + err.message);
      } finally {
        isSending = false;
        button.disabled = false;
      }
    }

    button.addEventListener("click", sendQuestion);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendQuestion();
      }
    });
  </script>
</body>
</html>
